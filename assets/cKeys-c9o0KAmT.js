import{u as j}from"./keys-3pn1V62-.js";import{e as C,u as M,f as $,g as R,h as z,a as l,w as s,F as J,r as b,o as V,d as g,i as w,t as N,j as x,c as L,k as T,E as h,l as W}from"./index-B3lzMfHP.js";import{f as _,c as K}from"./copyData-BSEk4TY7.js";import{_ as G,c as q}from"./copyLink-DgrSJAUB.js";function Q(v,d){const y=new Blob([d],{type:"text/csv"});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(y,v);else{const a=window.document.createElement("a");a.href=window.URL.createObjectURL(y),a.download=v,document.body.appendChild(a),a.click(),document.body.removeChild(a)}}function X(v){const d=window.document.createElement("input");d.type="file",document.body.appendChild(d),d.onchange=()=>{let y=d.files[0];document.body.removeChild(d),v(y)},d.oncancel=()=>{document.body.removeChild(d)},d.click()}const Y=g("h2",null,"Copy and share public key",-1),Z={class:"drawer-media-wrapper"},D={class:"drawer-media"},ee={class:"drawer-media"},ae=g("h2",null,"Generate keypair",-1),le={__name:"cKeys",setup(v){const d=C(window.outerWidth<900),y=M(),a=j(),c=$({name:"",passphrase:"",rpassphrase:""}),O=C(!1),m=$({isActive:!1,name:"",pub:"",priv:""});async function P(t){let e=!1;if(c.passphrase!=c.rpassphrase&&(h.error({message:"Passphrases do not match"}),e=!0,await k(1)),a.data.findIndex(r=>r.name==c.name)!=-1&&(h.error({message:"Name already exists"}),e=!0,await k(1)),c.name==""&&(h.error({message:"Name must not be empty"}),e=!0,await k(1)),e)return;let n=_.pki.rsa.generateKeyPair({bits:1024}),p=_.pki.encryptRsaPrivateKey(n.privateKey,_.util.encodeUtf8(c.passphrase)),o=_.pki.publicKeyToPem(n.publicKey),i=new Date;a.data.unshift({date:i,name:c.name.trim(),pub:o.trim(),priv:p.trim()}),a.set(),console.log(`"${c.name}" keypair was created`)}function k(t){return new Promise(e=>setTimeout(e,t))}function S(t){let e=a.data.findIndex(n=>n.name==t);m.isActive=!0,m.pub=a.data[e].pub,m.priv=a.data[e].priv,m.name=a.data[e].name,console.log(`"${t}" public key was shown`)}function B(t){K(m.pub,m.name,"public key")}function E(t){K(m.priv,m.name,"private key")}function H(t,e){let n=a.data.findIndex(p=>p.name==t);if(e=="click"){let p=window.location.protocol,o=window.location.hostname,i=window.location.port;i==""&&(i="443");let{href:r}=y.resolve({path:"encrypt",query:{publicKey:_.util.encode64(a.data[n].pub)}}),f=`${p}//${o}:${i}/Crypter/${r}`;q(f,m.name,"public key")}else e=="cancel"?console.log(`redirect to "${t}" public key cancelled`):e=="confirm"&&(y.push({path:"encrypt",query:{publicKey:_.util.encode64(a.data[n].pub)}}),console.log(`redirect to "${t}" public key confirmed`))}function A(t){let e=a.data.findIndex(n=>n.name==t);W.confirm(`Are you sure to delete key "${t}"?`).then(()=>{a.data.splice(e,1),a.set(),console.log(`"${t}" public key was deleted`)}).catch(n=>{n!="cancel"&&ElNotification.error({title:"Error",message:`deleteHandler(${t})
`})})}function F(){Q("keys.json",JSON.stringify(a.data)),console.log('keys were exported to "keys.json"')}function U(t){if(t.size>4*2**20){h.error({message:"File is larger than 4MB"});return}const e=new FileReader;e.onload=()=>{let n={};try{n=JSON.parse(e.result)}catch{h.error({message:"File isn't JSON"});return}if(!Array.isArray(n)){h.error({message:"Incorrect JSON format: isn't array"});return}let p=!1;n.forEach(o=>{var i;if(o.hasOwnProperty("date")&&o.hasOwnProperty("name")&&o.hasOwnProperty("pub")&&o.hasOwnProperty("priv")&&a.data.find(r=>r.date===o.date&&r.pub===o.pub&&r.priv===o.priv)===void 0){p=!0;let r={};if(a.data.find(u=>u.name==o.name)===void 0)r.name=o.name;else{let u=2;for(;r.name===void 0;)a.data.find(I=>I.name===o.name+`_${u}`)===void 0&&(r.name=o.name+`_${u}`),u++}r.date=o.date,r.pub=o.pub,r.priv=o.priv;let f=0;for(;a.data[f]!=null&&((i=a.data[f])==null?void 0:i.date)>r.date;)f++;a.data.splice(f,0,r)}}),p?(a.set(),console.log(`some keys were imported from "${t.name}"`)):h({message:"Nothing has been added"})},e.readAsText(t)}return R(()=>{a.get()}),addEventListener("resize",()=>{d.value=window.outerWidth<900}),(t,e)=>{const n=b("el-text"),p=b("el-button"),o=b("el-drawer"),i=b("el-form-item"),r=b("el-input"),f=b("el-form");return V(),z(J,null,[l(o,{size:d.value?"100%":"50%",modelValue:m.isActive,"onUpdate:modelValue":e[0]||(e[0]=u=>m.isActive=u)},{header:s(()=>[Y]),default:s(()=>[g("div",Z,[g("div",D,[l(n,null,{default:s(()=>[w(N(m.pub),1)]),_:1})]),g("div",ee,[l(n,null,{default:s(()=>[w(N(m.priv),1)]),_:1})])])]),footer:s(()=>[l(p,{type:"success",onClick:B},{default:s(()=>[w(" Copy public ")]),_:1}),l(p,{type:"danger",onClick:E},{default:s(()=>[w(" Copy private ")]),_:1})]),_:1},8,["size","modelValue"]),l(f,null,{default:s(()=>[l(i,null,{default:s(()=>[l(n,null,{default:s(()=>[ae]),_:1})]),_:1}),l(i,null,{default:s(()=>[l(r,{modelValue:c.name,"onUpdate:modelValue":e[1]||(e[1]=u=>c.name=u),placeholder:"keypair name"},null,8,["modelValue"])]),_:1}),l(i,null,{default:s(()=>[l(r,{"show-password":"",modelValue:c.passphrase,"onUpdate:modelValue":e[2]||(e[2]=u=>c.passphrase=u),placeholder:"passphrase"},null,8,["modelValue"])]),_:1}),l(i,null,{default:s(()=>[l(r,{"show-password":"",modelValue:c.rpassphrase,"onUpdate:modelValue":e[3]||(e[3]=u=>c.rpassphrase=u),placeholder:"repeat passphrase"},null,8,["modelValue"])]),_:1}),l(i,null,{default:s(()=>[l(p,{onClick:P,type:"success"},{default:s(()=>[w(" Submit ")]),_:1}),l(p,{onClick:F},{default:s(()=>[w(" Export ")]),_:1}),l(p,{onClick:e[4]||(e[4]=u=>x(X)(U))},{default:s(()=>[w(" Import ")]),_:1})]),_:1}),x(a).data.length!=0?(V(),L(i,{key:0},{default:s(()=>[l(G,{data:x(a).data,loading:O.value,"is-mobile":d.value,onShow:S,onShare:H,onDelete:A},null,8,["data","loading","is-mobile"])]),_:1})):T("",!0)]),_:1})],64)}}};export{le as default};
